version: '3.8'

services:
  orly-relay:
    image: silberengel/next-orly:latest
    ports:
      - "3334:7777"
    environment:
      - ORLY_LISTEN=0.0.0.0
      - ORLY_PORT=7777
      - ORLY_LOG_LEVEL=info
      - ORLY_MAX_CONNECTIONS=1000
      - ORLY_ACL_MODE=none
    volumes:
      - orly_data:/data
    networks:
      - nostrbots-network
    user: "1000:1000"

  jenkins:
    image: jenkins/jenkins:lts
    ports:
      - "8080:8080"
    environment:
      - JENKINS_OPTS=--httpPort=8080
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=false
      - JENKINS_ADMIN_ID=${JENKINS_ADMIN_ID:-admin}
      - JENKINS_ADMIN_PASSWORD=${JENKINS_ADMIN_PASSWORD:-admin}
    volumes:
      - jenkins_data:/var/jenkins_home
      - /opt/nostrbots/scripts/jenkins-setup.groovy:/usr/share/jenkins/ref/init.groovy.d/setup.groovy
    secrets:
      - nostr_bot_key_encrypted
      - nostr_bot_npub
    networks:
      - nostrbots-network
    user: "1000:1000"
    working_dir: /var/jenkins_home/workspace

  nostrbots-agent:
    image: silberengel/nostrbots:latest
    environment:
      - NOSTR_BOT_KEY_ENCRYPTED_FILE=/run/secrets/nostr_bot_key_encrypted
      - NOSTR_BOT_NPUB_FILE=/run/secrets/nostr_bot_npub
    secrets:
      - nostr_bot_key_encrypted
      - nostr_bot_npub
    networks:
      - nostrbots-network
    command: >
      sh -c "
        echo 'Starting Nostrbots agent...' &&
        tail -f /dev/null
      "

  backup-agent:
    image: silberengel/nostrbots:latest
    environment:
      - NOSTR_BOT_KEY_ENCRYPTED_FILE=/run/secrets/nostr_bot_key_encrypted
      - NOSTR_BOT_NPUB_FILE=/run/secrets/nostr_bot_npub
    volumes:
      - jenkins_data:/var/jenkins_home:ro
      - orly_data:/app/data:ro
      - backup_data:/backups
    secrets:
      - nostr_bot_key_encrypted
      - nostr_bot_npub
    networks:
      - nostrbots-network
    command: >
      sh -c "
        echo 'Starting backup agent...' &&
        tail -f /dev/null
      "

volumes:
  orly_data:
    driver: local
  jenkins_data:
    driver: local
  backup_data:
    driver: local

secrets:
  nostr_bot_key_encrypted:
    external: true
  nostr_bot_npub:
    external: true

networks:
  nostrbots-network:
    driver: overlay
    attachable: true
