import java.text.SimpleDateFormat

// Get the current date-time for Berlin time zone
def timeStamp = Calendar.getInstance().getTime().format('YYYY:MM:dd:HH:mm:ss',TimeZone.getTimeZone('CET'))
println "Timestamp is: ${timeStamp}"
// Extract current hour
def thisHour = timeStamp
thisHour = thisHour .split(":")
thisHour = thisHour [3]
println "The hour is ${thisHour}"

// Get the the current weekday as an integer, with Sunday being 1
def weekday = Calendar.getInstance().get(Calendar.DAY_OF_WEEK)
println "Weekday is: ${weekday}"
def thisWeekday = "weekday not yet set"
// Change it to European-style calendar weeks (beginning with Monday) and to text weekdays
switch(weekday) {
  case 1:
    thisWeekday = "Sunday"
    break;
  case 2:
    thisWeekday = "Monday"
    break;
  case 3:
    thisWeekday = "Tuesday"
    break;
  case 4:
    thisWeekday = "Wednesday"
    break;
  case 5:
    thisWeekday = "Thursday"
    break;
  case 6:
    thisWeekday = "Friday"
    break;
  case 7:
    thisWeekday = "Saturday"
    break;
}
println "Written-out weekday is: ${thisWeekday}"

pipeline 
{
    agent any
    
    environment {
        NOSTR_BOT_KEY1 = credentials('financial-bot-key')
        NOSTR_BOT_KEY2 = credentials('catholic-bot-key')
        NOSTR_BOT_KEY3 = credentials('katholisch-bot-key')
    }

    stages {
    
        stage('build') {
            steps {
                // Make sure dependencies are installed
                sh 'composer install'
            }
        }

        stage('finance bot') {
            when 
                {
                    expression {
                        (thisWeekday == "Monday") && (thisHour == "09")
                    }
                }
            steps {
                script {
                    println "Step running because day is ${thisWeekday} and hour is ${thisHour}."
                    // post some financial data
                    def output = sh(returnStdout: true, script: 'php src/botscripts/mondayFinanceBot.php')
                    echo "Output: ${output}"
                }
            }
        }

        stage('catholic morning bot') {
            when 
                {
                    expression {
                        thisHour == "05"
                    }
                }
            steps {
                script {
                    println "Step running because time is ${thisHour}."
                    // post morning readings
                    def output = sh(returnStdout: true, script: 'php src/botscripts/catholicMorningBot.php')
                    echo "Output: ${output}"
                    def output2 = sh(returnStdout: true, script: 'php src/botscripts/katholischMorningBot.php')
                    echo "Output: ${output2}"
                }
            }
        }

        stage('catholic evening bot') {
            when 
                {
                    expression {
                        thisHour == "18"
                    }
                }
            steps {
                script {
                    println "Step running because time is ${thisHour}."
                    // post evening readings
                    def output = sh(returnStdout: true, script: 'php src/botscripts/catholicEveningBot.php')
                    echo "Output: ${output}"
                    def output2 = sh(returnStdout: true, script: 'php src/botscripts/katholischEveningBot.php')
                    echo "Output: ${output2}"
                }
            }
        }
    }
}
