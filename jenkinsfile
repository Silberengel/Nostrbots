import java.text.SimpleDateFormat

// Get the current date-time for Berlin time zone
def timeStamp = Calendar.getInstance().getTime().format('YYYY:MM:dd:HH:mm:ss',TimeZone.getTimeZone('CET'))
println "Timestamp is: ${timeStamp}"
// Extract current hour
def thisHour = timeStamp
thisHour = thisHour .split(":")
thisHour = thisHour [3]
println "The hour is ${thisHour}"

// Get the the current weekday as an integer, with Sunday being 1
def weekday = Calendar.getInstance().get(Calendar.DAY_OF_WEEK)
println "Weekday is: ${weekday}"
def thisWeekday = "weekday not yet set"
// Change it to European-style calendar weeks (beginning with Monday) and to text weekdays
switch(weekday) {
  case 1:
    thisWeekday = "Sunday"
    break;
  case 2:
    thisWeekday = "Monday"
    break;
  case 3:
    thisWeekday = "Tuesday"
    break;
  case 4:
    thisWeekday = "Wednesday"
    break;
  case 5:
    thisWeekday = "Thursday"
    break;
  case 6:
    thisWeekday = "Friday"
    break;
  case 7:
    thisWeekday = "Saturday"
    break;
}
println "Written-out weekday is: ${thisWeekday}"

pipeline 
{
    agent any
    
    stages {
    
        stage('check system') {
            steps {
                    // do something
                    // check to make sure nsecs are stored in environment variables and return the relevant npubs
                    // check to make sure that all target relays are running
                    echo "system check PASS"
                }
        }

        stage('finance bot') {
            when 
                {
                    expression {
                        (thisWeekday == "Monday") && (thisHour == "09")
                    }
                }
            steps {
                    println "Step running because day is ${thisWeekday} and hour is ${thisHour}."
                    // post some financial data
                    sh 'php mondayFinanceBot.php'
                }
        }

        stage('catholic morning bot') {
            when 
                {
                    expression {
                        thisHour == "05"
                    }
                }
            steps {
                    println "Step running because time is ${thisHour}."
                    // post morning readings
                    sh 'php catholicMorningBot.php'
                }
        }

        stage('catholic evening bot') {
            when 
                {
                    expression {
                        thisHour == "17"
                    }
                }
            steps {
                    println "Step running because time is ${thisHour}."
                    // post evening readings
                    sh 'php catholicEveningBot.php'
                }
        }
    }
}
